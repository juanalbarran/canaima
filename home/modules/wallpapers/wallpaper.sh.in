#!@bash@
PATH="@coreutils@:@findutils@:@swww@:@libnotify@:@jq@"

LOG_FILE="/tmp/wallpaper.log"

# --- 1. Start Daemon if needed ---
if ! pgrep -x "swww-daemon" > /dev/null; then
    echo "Starting swww-daemon..." >> $LOG_FILE
    swww-daemon &
    sleep 1
fi

# --- 2. Define Directories ---
# Adjust these matches to your exact folder names
DIR_ULTRAWIDE="$HOME/Pictures/Wallpapers/2560x1080"
DIR_STANDARD="$HOME/Pictures/Wallpapers/1920x1080"
# Fallback for Laptop if you don't have a 1366x768 specific folder
DIR_LAPTOP="$HOME/Pictures/Wallpapers/1920x1080" 

# --- 3. Function to select and apply wallpaper ---
apply_wallpaper() {
    local monitor_name=$1
    local width=$2
    local target_dir=""

    # Logic: Choose directory based on screen width
    if [ "$width" -ge 2500 ]; then
        echo "Monitor $monitor_name is Ultrawide ($width px)" >> $LOG_FILE
        target_dir="$DIR_ULTRAWIDE"
    elif [ "$width" -ge 1900 ]; then
        echo "Monitor $monitor_name is Standard ($width px)" >> $LOG_FILE
        target_dir="$DIR_STANDARD"
    else
        echo "Monitor $monitor_name is Laptop/Small ($width px)" >> $LOG_FILE
        target_dir="$DIR_LAPTOP"
    fi

    # Pick a random image from that directory
    if [ -d "$target_dir" ]; then
        img=$(find -L "$target_dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | shuf -n 1)
        
        if [ -n "$img" ]; then
            echo "Applying $img to $monitor_name" >> $LOG_FILE
            # Apply ONLY to this specific output
            swww img "$img" --outputs "$monitor_name" --transition-type grow --transition-pos 0.5,0.5 --transition-fps 60 --transition-step 90 &
        else
            echo "Warning: No images found in $target_dir" >> $LOG_FILE
        fi
    else
        echo "Error: Directory $target_dir does not exist." >> $LOG_FILE
    fi
}

# --- 4. Detect Monitors (Sway vs Hyprland) ---

if [ "$XDG_CURRENT_DESKTOP" = "sway" ]; then
    # Parse Sway Output: Get Name and Width of active screens
    swaymsg -t get_outputs | jq -r '.[] | select(.active) | "\(.name) \(.current_mode.width)"' | \
    while read -r name width; do
        apply_wallpaper "$name" "$width"
    done

elif [ "$XDG_CURRENT_DESKTOP" = "Hyprland" ]; then
    # Parse Hyprland Output: Get Name and Width
    hyprctl monitors -j | jq -r '.[] | "\(.name) \(.width)"' | \
    while read -r name width; do
        apply_wallpaper "$name" "$width"
    done

else
    echo "Unknown Desktop Environment: $XDG_CURRENT_DESKTOP" >> $LOG_FILE
    exit 1
fi

wait # Wait for background swww processes to finish
echo "Wallpapers updated at $(date)" >> $LOG_FILE

