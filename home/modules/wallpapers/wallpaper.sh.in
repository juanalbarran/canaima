#!@bash@
# Note: swww is REMOVED from the PATH below
export PATH="@coreutils@:@findutils@:@libnotify@:@jq@:@procps@:$PATH"

# --- Define Commands ---
SWWW_DAEMON="@swww_daemon_cmd@"
SWWW_CLIENT="@swww_client_cmd@"

LOG_FILE="/tmp/wallpaper.log"

echo "--- Script triggered at $(date) ---" >> $LOG_FILE

# 1. Check Environment
if [ -z "$WAYLAND_DISPLAY" ]; then
    echo "Notice: Session is not ready. Skipping..." >> $LOG_FILE
    exit 0
fi

# 2. Start Daemon if not running
if ! pgrep -f "swww-daemon" > /dev/null; then
    echo "Starting swww-daemon..." >> $LOG_FILE
    # Start it and capture errors just in case
    $SWWW_DAEMON >> "$LOG_FILE" 2>&1 &
else
    echo "swww-daemon is already running." >> $LOG_FILE
fi

# 3. Wait for Daemon Readiness (The Robust Way)
echo "Waiting for swww to become ready..." >> $LOG_FILE

TIMEOUT=0
# We try to run 'swww query'. If it returns 0 (success), the socket is working.
while ! $SWWW_CLIENT query > /dev/null 2>&1; do
    sleep 0.5
    TIMEOUT=$((TIMEOUT+1))
    if [ $TIMEOUT -ge 20 ]; then
        echo "Error: Timed out waiting for swww." >> $LOG_FILE
        exit 1
    fi
done
echo "Daemon is ready! Proceeding..." >> $LOG_FILE

# --- 4. Define Directories ---
DIR_ULTRAWIDE="$HOME/Pictures/Wallpapers/2560x1080"
DIR_STANDARD="$HOME/Pictures/Wallpapers/1920x1080"
DIR_LAPTOP="$HOME/Pictures/Wallpapers/1920x1080" 

# --- 5. Application Logic ---
apply_wallpaper() {
    local monitor_name=$1
    local width=$2
    local target_dir=""

    echo "Processing monitor: $monitor_name ($width px)" >> $LOG_FILE

    if [ "$width" -ge 2500 ]; then
        target_dir="$DIR_ULTRAWIDE"
    elif [ "$width" -ge 1900 ]; then
        target_dir="$DIR_STANDARD"
    else
        target_dir="$DIR_LAPTOP"
    fi

    if [ -d "$target_dir" ]; then
        img=$(find -L "$target_dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | shuf -n 1)
        
        if [ -n "$img" ]; then
            echo "  -> Applying: $img" >> $LOG_FILE
            $SWWW_CLIENT img "$img" --outputs "$monitor_name" --transition-type grow --transition-pos 0.5,0.5 --transition-fps 60 --transition-step 90 &
            #$SWWW_CLIENT img "$img" &
        else
            echo "  -> Error: No images found in $target_dir" >> $LOG_FILE
        fi
    else
        echo "  -> Error: Directory $target_dir does not exist." >> $LOG_FILE
    fi
}

# --- 6. Desktop Environment Detection ---
if [ "$XDG_CURRENT_DESKTOP" = "sway" ]; then
    if [ -z "$SWAYSOCK" ]; then
        echo "Warning: SWAYSOCK is empty. Attempting to continue..." >> $LOG_FILE
    fi
    
    swaymsg -t get_outputs | jq -r '.[] | select(.active) | "\(.name) \(.current_mode.width)"' | \
    while read -r name width; do
        apply_wallpaper "$name" "$width"
    done

elif [ "$XDG_CURRENT_DESKTOP" = "Hyprland" ]; then
    hyprctl monitors -j | jq -r '.[] | "\(.name) \(.width)"' | \
    while read -r name width; do
        apply_wallpaper "$name" "$width"
    done

else
    echo "Unknown Desktop: $XDG_CURRENT_DESKTOP" >> $LOG_FILE
fi

wait
echo "Script finished successfully." >> $LOG_FILE

